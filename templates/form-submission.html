<!DOCTYPE html>
<html>
<head>
  <title>Form Submission</title>
  <link rel="stylesheet" href="static/css/styles.css" />
</head>
<body>
  <h2 id="form-title">Loading...</h2>
  <form id="dynamic-form"></form>

  <script>
    const token = localStorage.getItem("access_token") || "PASTE_YOUR_USER_TOKEN_HERE";
    const formId = new URLSearchParams(window.location.search).get("id"); // Get ?id= from URL

    async function loadForm() {
      try {
        const res = await fetch(`http://127.0.0.1:8000/user/forms/${formId}`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        if (!res.ok) {
          const err = await res.json();
          document.getElementById("form-title").innerText = err.detail || "Failed to load form.";
          return;
        }

        const form = await res.json();
        document.getElementById("form-title").innerText = `Fill Form: ${form.title}`;
        const formContainer = document.getElementById("dynamic-form");

        form.fields.forEach(field => {
          const label = document.createElement("label");
          label.innerText = field.label;

          let input;
          if (field.field_type === "dropdown") {
            input = document.createElement("select");
            field.options.forEach(opt => {
              const option = document.createElement("option");
              option.value = opt;
              option.text = opt;
              input.appendChild(option);
            });
          } else if (field.field_type === "checkbox") {
            input = document.createElement("input");
            input.type = "checkbox";
          } else {
            input = document.createElement("input");
            input.type = field.field_type || "text";
          }

          input.name = field.label;
          if (field.required) input.required = true;

          formContainer.appendChild(label);
          formContainer.appendChild(input);
          formContainer.appendChild(document.createElement("br"));
        });

        // Add submit button
        const submitBtn = document.createElement("button");
        submitBtn.type = "submit";
        submitBtn.innerText = "Submit";
        formContainer.appendChild(submitBtn);

        formContainer.onsubmit = async function (e) {
          e.preventDefault();

          const data = {};
          form.fields.forEach(field => {
            const input = document.querySelector(`[name="${field.label}"]`);
            if (field.field_type === "checkbox") {
              data[field.label] = input.checked;
            } else {
              data[field.label] = input.value;
            }
          });

          const resp = await fetch(`http://127.0.0.1:8000/user/forms/${formId}/submit`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({ response_data: data })
          });

          const result = await resp.json();
          if (resp.ok) {
            alert("✅ " + result.message);
          } else {
            alert("❌ " + result.detail);
          }
        };

      } catch (err) {
        document.getElementById("form-title").innerText = "Error loading form";
        console.error(err);
      }
    }

    loadForm();
  </script>
</body>
</html>
