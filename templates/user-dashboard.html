<!DOCTYPE html>
<html>
  <head>
    <title>User Dashboard</title>
    <meta name="api-base-url" content="{{ API_BASE_URL }}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="static/css/styles.css" />
    <link rel="stylesheet" href="static/css/user-dashboard.css" />
  </head>
  <body>
    <div class="dashboard-header">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="dashboard-title">Dashboard</h1>
          <a href="/submission-history" class="view-submissions-btn">
            <i class="bi bi-journal-text me-1"></i>
            View My Submissions
          </a>
          <!-- LOGOUT BUTTON  -->
          <button id="logout-btn" class="view-submissions-btn">
            <i class="bi bi-box-arrow-right me-1"></i>
            Logout
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <h2 class="section-title">Assigned Forms</h2>
      <div id="form-list"></div>

      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-title">Total Forms</div>
          <div class="stat-number" id="total-forms">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Completed</div>
          <div class="stat-number completed" id="completed-forms">0</div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const formList = document.getElementById("form-list");
        const totalFormsEl = document.getElementById("total-forms");
        const completedFormsEl = document.getElementById("completed-forms");
        const token = localStorage.getItem("access_token");

        if (!token) {
          alert("You must log in first.");
          window.location.href = "login.html";
          return;
        }

        try {
          let submittedFormIds = [];

          //- Getting the API BASE URL from env
          const apiBaseUrl = document
            .querySelector('meta[name="api-base-url"]')
            .getAttribute("content");


          // Step 1: Fetch submitted form IDs
          const submissionsRes = await fetch(
            `${apiBaseUrl}/user/forms`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (submissionsRes.ok) {
            const submissions = await submissionsRes.json();
            submittedFormIds = submissions.map((s) => s.form_id);
          }

          // Step 2: Fetch assigned forms
          const formsRes = await fetch(
            `${apiBaseUrl}/user/forms/assigned`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!formsRes.ok) {
            throw new Error("Failed to fetch assigned forms");
          }

          const forms = await formsRes.json();

          // Update statistics
          const totalForms = forms.length;
          const completedForms = forms.filter((form) =>
            submittedFormIds.includes(form.id)
          ).length;

          totalFormsEl.textContent = totalForms;
          completedFormsEl.textContent = completedForms;

          // Render forms
          if (forms.length === 0) {
            formList.innerHTML = `
            <div class="no-forms">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6; margin-bottom: 1rem;"></i>
              <p>No forms assigned.</p>
            </div>
          `;
          } else {
            formList.innerHTML = forms
              .map((form) => {
                const isSubmitted = submittedFormIds.includes(form.id);
                const description =
                  form.description ||
                  `Complete your ${form.title.toLowerCase()}`;

                return `
              <div class="form-card">
                <div class="form-title">${form.title}</div>
                <div class="form-description">${description}</div>
                <div class="d-flex justify-content-between align-items-center">
                  <div></div>
                  ${
                    isSubmitted
                      ? `<span class="status-submitted">
                         <i class="bi bi-check-circle-fill"></i>
                         Submitted
                       </span>`
                      : `<a href="/form-submission?form_id=${form.id}" class="fill-form-btn">
                         <i class="bi bi-pencil-fill"></i>
                         Fill Form
                       </a>`
                  }
                </div>
              </div>
            `;
              })
              .join("");
          }
        } catch (err) {
          console.error("Error loading dashboard:", err);
          formList.innerHTML = `
          <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Error loading forms: ${err.message}
          </div>
        `;
        }
      });

      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("access_token");
        window.location.href = "/";
      });
    </script>
  </body>
</html>
